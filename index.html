<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RFID Inventory â€” Milk & Cheese</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; 
           max-width:900px; margin:40px auto; color:#111; padding:0 18px; }
    h1 { margin-bottom:6px; }
    p.lead { color:#555; margin-top:0; }
    .card { border:1px solid #e6e6e6; padding:16px; border-radius:8px; 
            box-shadow:0 1px 2px rgba(0,0,0,0.05); margin-top:18px;
            display:flex; justify-content:space-between; align-items:center; }
    .name { font-weight:600; font-size:1.05rem; }
    .tag { font-family: monospace; color:#333; background:#f7f7f7; padding:6px 10px; border-radius:6px; }
    .time { color:#666; font-size:0.9rem; }
    .empty { color:#777; text-align:center; padding:28px 0; }
    footer { margin-top:28px; color:#888; font-size:0.9rem; }
  </style>
</head>
<body>

  <h1>RFID Inventory</h1>
  <p class="lead">Live inventory updates from your RFID scanner (Milk & Cheese only)</p>

  <div id="list"></div>
  <div id="message" class="empty">Loadingâ€¦</div>

  <footer>
    <div id="info">Source: <span id="source"></span></div>
  </footer>

<script>
/*
  ------------------------------------------------------------------
  WHERE TO INPUT YOUR CLOUDANT CREDENTIALS
  ------------------------------------------------------------------
  CLOUDANT_HOST     â†’ from service credentials field "host"
  CLOUDANT_USERNAME â†’ from Cloudant Dashboard â†’ Permissions â†’ Generate API Key
  CLOUDANT_PASSWORD â†’ the API key password (shown once)
*/

// ---------------------------
// ðŸ”§ INPUT YOUR DETAILS HERE
// ---------------------------

// 1ï¸âƒ£ CLOUDANT HOST (from service credentials "host")
const CLOUDANT_HOST = "edcecae3-6a3a-41d0-937b-6e683f4daab1-bluemix.cloudantnosqldb.appdomain.cloud";

// 2ï¸âƒ£ CLOUDANT API KEY USERNAME (from Cloudant Dashboard)
const CLOUDANT_USERNAME = "apikey-v2-2aut8n4i1m8k7grznfg8v7fxmtajfliolvhn64v9gaje";

// 3ï¸âƒ£ CLOUDANT API KEY PASSWORD (shown once during API key generation)
const CLOUDANT_PASSWORD = "f88f0d9fb00d15f34a97fc29ce844746";

// 4ï¸âƒ£ Your database name
const DB_NAME = "inventory";

// --------------------------------------------------
// Construct Cloudant HTTPS endpoint
// --------------------------------------------------
const ENDPOINT =
  `https://${CLOUDANT_HOST}/${DB_NAME}/_all_docs?include_docs=true`;


// -----------------------------
// Product mappings
// -----------------------------
const TAG_MAP = {
  "E264F905": "Milk",
  "648EF705": "Cheese"
};


// ---------------------------
// Cloudant Basic Auth
// ---------------------------
function basicAuthHeader(user, pass) {
  return 'Basic ' + btoa(user + ':' + pass);
}


// -----------------------------
// Fetch and normalize docs
// -----------------------------
async function fetchDocs() {
  const headers = {
    'Authorization': basicAuthHeader(CLOUDANT_USERNAME, CLOUDANT_PASSWORD),
    'Accept': 'application/json'
  };

  const res = await fetch(ENDPOINT, { method: "GET", headers });
  if (!res.ok) throw new Error("HTTP " + res.status);

  const json = await res.json();

  if (Array.isArray(json.rows)) {
    return json.rows.map(r => ({
      _id: r.id,
      tag: r.doc.tag || r.id,
      last_seen: r.doc.last_seen || null,
      count: r.doc.count || 0
    }));
  }

  return [];
}


// -----------------------------
// Helpers
// -----------------------------
function prettyTime(ts) {
  if (!ts) return "â€”";
  const sec = Math.round((Date.now() - ts) / 1000);
  if (sec < 60) return sec + "s ago";
  if (sec < 3600) return Math.round(sec/60) + "m ago";
  return new Date(ts).toLocaleString();
}


// -----------------------------
// Render UI
// -----------------------------
function render(docs) {
  const list = document.getElementById("list");
  const msg  = document.getElementById("message");
  document.getElementById("source").textContent = ENDPOINT;

  const filtered = docs.filter(d => TAG_MAP[d.tag]);

  if (filtered.length === 0) {
    msg.textContent = "No mapped items found.";
    list.innerHTML = "";
    return;
  }

  msg.textContent = "";
  list.innerHTML = "";

  Object.keys(TAG_MAP).forEach(tagId => {
    const doc = filtered.find(d => d.tag === tagId);
    if (!doc) return;

    const el = document.createElement("div");
    el.className = "card";
    el.innerHTML = `
      <div>
        <div class="name">${TAG_MAP[tagId]}</div>
        <div class="time">Last seen: ${prettyTime(doc.last_seen)}</div>
        <div class="time">Count: ${doc.count}</div>
      </div>
      <div style="text-align:right">
        <div class="tag">${tagId}</div>
      </div>
    `;
    list.appendChild(el);
  });
}


// -----------------------------
// Load Cloudant data
// -----------------------------
async function load() {
  try {
    const docs = await fetchDocs();
    render(docs);
  } catch (err) {
    console.error(err);
    document.getElementById("message").textContent =
      "Could not fetch live data. Check credentials or CORS.";
  }
}

load();
setInterval(load, 5000);
</script>

</body>
</html>
